name: Android Vulkan Build

on:
  push:
    paths:
      - '.github/workflows/android-vulkan.yml'
      - 'ggml/**'
      - 'src/**'
      - 'examples/whisper.android/**'
  workflow_dispatch:

jobs:
  android-vulkan:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Vulkan SDK
      run: |
        # LunarG Vulkan SDK のインストール
        wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
        sudo apt update
        sudo apt install -y vulkan-sdk
        
        # 確認
        glslc --version
        echo "Vulkan SDK installed successfully"

    - name: Install dependencies
      run: sudo apt-get install -y ninja-build

    - name: Install NDK
      run: sdkmanager --install "ndk;25.2.9519653"

    - name: Download Whisper model
      run: |
        mkdir -p examples/whisper.android/app/src/main/assets/models
        wget -q https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin -O examples/whisper.android/app/src/main/assets/models/ggml-base.bin
        ls -lh examples/whisper.android/app/src/main/assets/models/

    - name: Download Vulkan Headers for Android NDK
      run: |
        # Android NDK 25.2のVulkan headersは古い（1.3）ため、最新のVulkan-HeadersとVulkan-Hppを使う
        # Vulkan-Headers（C headers）+ Vulkan-Hpp（C++ headers）の両方が必要
        git clone --depth 1 https://github.com/KhronosGroup/Vulkan-Headers.git /tmp/Vulkan-Headers
        git clone --depth 1 https://github.com/KhronosGroup/Vulkan-Hpp.git /tmp/Vulkan-Hpp
        
        mkdir -p external
        # C headers (vulkan/vulkan.h, vulkan_core.h, etc.)
        cp -r /tmp/Vulkan-Headers/include/* external/
        # C++ headers (vulkan.hpp, etc.) - vulkan/ に追加
        cp -r /tmp/Vulkan-Hpp/vulkan/* external/vulkan/
        
        echo "Vulkan headers installed:"
        ls external/vulkan/*.h | head -5
        ls external/vulkan/*.hpp | head -5

    - name: Enable Vulkan in CMakeLists
      run: |
        cd examples/whisper.android/lib/src/main/jni/whisper
        # GGML_VULKAN=ON を設定 + Vulkan-Hppインクルードパス追加
        sed -i 's/include(FetchContent)/set(GGML_VULKAN ON CACHE BOOL "Enable Vulkan" FORCE)\ninclude(FetchContent)/' CMakeLists.txt
        # external/をインクルードパスに追加（7階層上）- BEFOREでNDKより優先
        sed -i 's|FetchContent_MakeAvailable(ggml)|include_directories(BEFORE SYSTEM ${CMAKE_SOURCE_DIR}/../../../../../../../external)\nFetchContent_MakeAvailable(ggml)|' CMakeLists.txt
        echo "=== Modified CMakeLists.txt ==="
        cat CMakeLists.txt

    - name: Update minSdk and ABI for Vulkan 1.1 support
      run: |
        # Vulkan 1.1 (vkGetPhysicalDeviceFeatures2等) はAPI 29以上が必要
        sed -i 's/minSdk 26/minSdk 29/g' examples/whisper.android/app/build.gradle
        sed -i 's/minSdk 26/minSdk 29/g' examples/whisper.android/lib/build.gradle
        
        # arm64-v8aのみに限定（32bitはVulkan-Hppのostreamサポート問題あり）
        sed -i "s/abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86_64'/abiFilters 'arm64-v8a'/g" examples/whisper.android/app/build.gradle
        sed -i "s/abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86_64'/abiFilters 'arm64-v8a'/g" examples/whisper.android/lib/build.gradle
        
        echo "Updated minSdk to 29 and ABI to arm64-v8a only"

    - name: Build Android APK
      run: |
        cd examples/whisper.android
        ./gradlew assembleRelease
      env:
        ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: whisper-android-vulkan
        path: examples/whisper.android/app/build/outputs/apk/release/*.apk
