name: Android Vulkan Build

on:
  push:
    paths:
      - '.github/workflows/android-vulkan.yml'
  workflow_dispatch:

jobs:
  android-vulkan:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y ninja-build

    - name: Install NDK
      run: sdkmanager --install "ndk;25.2.9519653"

    - name: Download Whisper model
      run: |
        mkdir -p examples/whisper.android/app/src/main/assets/models
        wget -q https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin -O examples/whisper.android/app/src/main/assets/models/ggml-base.bin
        ls -lh examples/whisper.android/app/src/main/assets/models/

    - name: Download Vulkan-Hpp
      run: |
        mkdir -p external/vulkan
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan.hpp -O external/vulkan/vulkan.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_enums.hpp -O external/vulkan/vulkan_enums.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_funcs.hpp -O external/vulkan/vulkan_funcs.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_handles.hpp -O external/vulkan/vulkan_handles.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_structs.hpp -O external/vulkan/vulkan_structs.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_to_string.hpp -O external/vulkan/vulkan_to_string.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_hash.hpp -O external/vulkan/vulkan_hash.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_raii.hpp -O external/vulkan/vulkan_raii.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_static_assertions.hpp -O external/vulkan/vulkan_static_assertions.hpp
        wget -q https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/main/vulkan/vulkan_format_traits.hpp -O external/vulkan/vulkan_format_traits.hpp
        ls -la external/vulkan/

    - name: Enable Vulkan in CMakeLists
      run: |
        cd examples/whisper.android/lib/src/main/jni/whisper
        # FetchContentの前にGGML_VULKANを設定
        sed -i 's/include(FetchContent)/set(GGML_VULKAN ON CACHE BOOL "Enable Vulkan" FORCE)\ninclude(FetchContent)/' CMakeLists.txt
        # Vulkan-Hppのインクルードパスを追加
        sed -i 's|FetchContent_MakeAvailable(ggml)|include_directories(${CMAKE_SOURCE_DIR}/../../../../../../../../../../../external/vulkan)\nFetchContent_MakeAvailable(ggml)|' CMakeLists.txt
        echo "=== Modified CMakeLists.txt ==="
        cat CMakeLists.txt

    - name: Build Android APK
      run: |
        cd examples/whisper.android
        ./gradlew assembleRelease
      env:
        ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: whisper-android-vulkan
        path: examples/whisper.android/app/build/outputs/apk/release/*.apk
